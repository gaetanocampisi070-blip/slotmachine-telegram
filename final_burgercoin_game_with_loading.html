<!DOCTYPE html>

<html lang="it">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1, maximum-scale=1" name="viewport"/>
<title>BurgerCoin ‚Äî Idle Tap WebApp</title>
<meta content="#0a2a68" name="theme-color"/>
<style>
/* ===== THEME ===== */
:root{
  --bg:#0a2a68;
  --sky1:#224aa2;
  --sky2:#081b43;
	
  --panel:#121b36;
  --panel2:#1c2d5b;
  --wood:#a66b2d;
  --wood2:#8a541f;
  --gold1:#ffe082;
  --gold2:#ffca28;
  --gold3:#ffb300;
  --mint1:#b2ff59;
  --mint2:#69f0ae;
  --text:#fff;
  --muted:#c7d2fe;
  --shadow: 0 18px 32px rgba(0,0,0,.46);
  --inset: inset 0 -2px 0 rgba(0,0,0,.2), inset 0 2px 0 rgba(255,255,255,.12);
}

*{box-sizing:border-box}
html,body{height:100%;margin:0}
body{
  background: radial-gradient(120% 120% at 50% 0%, var(--sky1) 0%, var(--bg) 55%, var(--sky2) 100%);
  color:var(--text);
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Inter, Roboto, "Helvetica Neue", Arial, system-ui, sans-serif;
  -webkit-font-smoothing: antialiased;
  text-rendering: optimizeLegibility;
}

.app{
  max-width: 520px;
  margin: 0 auto;
  min-height: 100dvh;
  display:flex;
  flex-direction: column;
  gap: 12px;
  padding: 10px 10px 20px;
}

/* TOP BAR */
.topbar{
  display:flex; align-items:center; gap:8px; flex-wrap:wrap;
  padding: 10px;
  background: linear-gradient(180deg, var(--panel2), var(--panel));
  border-radius: 16px;
  box-shadow: var(--shadow);
  border: 1px solid rgba(255,255,255,.06);
}
.pill{
  display:flex; align-items:center; gap:8px;
  background: rgba(10,15,35,.8);
  border:1px solid rgba(255,255,255,.08);
  padding:8px 12px;
  border-radius:999px;
  box-shadow: var(--inset);
  white-space:nowrap;
}
.pill b{font-variant-numeric: tabular-nums;}
.icon{width:18px;height:18px;vertical-align:middle;display:inline-block}

/* CABINET (wood frame) */
.cabinet{
  position:relative;
  background: linear-gradient(180deg, #c47b33 0%, var(--wood) 60%, var(--wood2) 100%);
  border-radius: 28px;
  padding: 16px 12px 18px;
  box-shadow: var(--shadow);
}
.titleBadge{
  position:absolute; top:-18px; left:50%; transform:translateX(-50%);
  background: linear-gradient(180deg, var(--gold1), var(--gold2) 60%, var(--gold3));
  color:#4a3000;
  font-weight:900; letter-spacing:.6px;
  padding:8px 16px; border-radius:999px;
  border:2px solid rgba(0,0,0,.18);
  text-shadow: 0 2px 0 rgba(255,255,255,.5);
  box-shadow: var(--shadow);
}
.panel{
  background: linear-gradient(180deg, #213055, #121b36);
  border-radius: 22px;
  padding: 12px;
  border:1px solid rgba(255,255,255,.06);
  box-shadow: var(--inset), var(--shadow);
}

/* XP */
.progress{display:flex; align-items:center; gap:10px}
.track{flex:1; height:14px; border-radius:999px; background: rgba(255,255,255,.08); box-shadow: inset 0 2px 4px rgba(0,0,0,.35); overflow:hidden}
.bar{height:100%; background: linear-gradient(90deg, var(--mint2), var(--mint1)); width:0%}
.badge{background:#0f1730;border:1px solid rgba(255,255,255,.1); padding:6px 10px; border-radius:12px}

/* Tap area */
.tapCard{
  margin-top:10px;
  display:grid; place-items:center;
  background: radial-gradient(60% 60% at 50% 35%, #22345f 0%, #121b36 60%);
  border-radius: 18px;
  border:1px solid rgba(255,255,255,.05);
  padding: 14px;
  position:relative; overflow:hidden;
  min-height: 230px;
}
.tapBtn{
  font-weight:900; font-size:22px; letter-spacing:.6px;
  padding:16px 26px; border-radius: 22px; border:none;
  color:#4a3000;
  background: linear-gradient(180deg, var(--gold1), var(--gold2) 60%, var(--gold3));
  box-shadow: 0 14px 24px rgba(0,0,0,.35), inset 0 3px 0 rgba(255,255,255,.85);
  transition: transform .05s ease, box-shadow .05s ease;
  margin-top: 150px;
}
.tapBtn:active{ transform: translateY(2px); box-shadow: 0 10px 18px rgba(0,0,0,.35), inset 0 2px 0 rgba(255,255,255,.6); }
.fly{ position:absolute; left:50%; top:56%; transform:translate(-50%,-50%); font-weight:900; text-shadow:0 2px 0 rgba(0,0,0,.3); opacity:0; }

/* Burger mascot */
.burger-wrap{ position:absolute; top:10px; left:50%; transform:translateX(-50%); width: 74%; max-width: 360px; user-select:none; pointer-events:none; filter: drop-shadow(0 10px 18px rgba(0,0,0,.35)); }
.burger-coin{ width:100%; height:auto; display:block; }

/* Tabs */
.tabs{ display:flex; gap:8px; margin-top:10px; flex-wrap:wrap }
.tab{ flex:1; text-align:center; padding:10px 8px; border-radius:12px; background: linear-gradient(180deg, #22345f, #121b36); border:1px solid rgba(255,255,255,.06); cursor:pointer; user-select:none }
.tab.active{ outline:2px solid #89f; }
.view{ display:none }
.view.active{ display:block }

/* Cards & lists */
.card{ background: linear-gradient(180deg, #22345f, #121b36); border:1px solid rgba(255,255,255,.06); border-radius: 16px; padding:12px; margin-bottom:10px }
.small{ font-size:12px; opacity:.85 }
.center{ text-align:center }
.grid2{ display:grid; grid-template-columns:1fr auto; gap:10px; align-items:center }
.btn{ background: linear-gradient(180deg, #94b4ff, #5b7aff); border:none; color:white; font-weight:700; padding:8px 12px; border-radius:10px; box-shadow: var(--shadow); cursor:pointer }
.btn:disabled{ opacity:.55; filter:grayscale(30%) }

.shopItem{
  display:flex; align-items:center; gap:10px;
  background: linear-gradient(180deg, #22345f, #111a34);
  border:1px solid rgba(255,255,255,.05);
  border-radius:14px; padding:10px; margin-bottom:8px;
}
.shopItem .right{ margin-left:auto; text-align:right }

.mission{ display:flex; align-items:center; gap:10px; padding:10px; background: linear-gradient(180deg, #22345f, #111a34); border:1px solid rgba(255,255,255,.05); border-radius:12px; margin-bottom:8px }
.mission .prog{ flex:1; height:8px; border-radius:999px; background:rgba(255,255,255,.1); overflow:hidden }
.mission .prog>div{ height:100%; background:linear-gradient(90deg, #8ae, #cdf) }

/* Wheel */
.wheelWrap{ display:grid; place-items:center; padding:10px }
.wheel{ width:250px; height:250px; border-radius:50%; background:conic-gradient(#ffd54d 0 45deg,#fdf 45deg 90deg,#9ff 90deg 135deg,#b2ff59 135deg 180deg,#ffa 180deg 225deg,#cfd 225deg 270deg,#fc9 270deg 315deg,#aff 315deg 360deg); box-shadow: var(--shadow); position:relative }
.wheel::after{ content:""; position:absolute; inset:10px; border-radius:50%; background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.6), rgba(255,255,255,0) 60%); }
.pointer{ width:0; height:0; border-left:14px solid transparent; border-right:14px solid transparent; border-bottom:18px solid #ff5252; margin-top:6px }

/* Leaderboard */
.table{ width:100%; border-collapse:separate; border-spacing:0 8px }
.tr{ display:grid; grid-template-columns:32px 1fr auto; gap:10px; align-items:center; background: linear-gradient(180deg, #1f2f58, #0f1730); border:1px solid rgba(255,255,255,.06); padding:8px 10px; border-radius:10px }

/* Toast */
.toast{ position:fixed; left:50%; bottom:18px; transform:translateX(-50%); background:#111a34; border:1px solid rgba(255,255,255,.1); color:#fff; padding:10px 14px; border-radius:12px; box-shadow: var(--shadow); opacity:0; pointer-events:none; transition:.3s opacity, .3s transform; z-index:10 }
.toast.show{ opacity:1; transform:translateX(-50%) translateY(-6px) }

@media (max-width: 360px){
  .tapBtn{ margin-top:130px }
}
</style>
</head>
<body>
<div class="loading-screen">
<img alt="BurgerCoin Logo" src="/mnt/data/IMG_8388.jpeg" style="width: 100px; height: 100px; margin-bottom: 20px;"/>
<p>Caricamento...</p>
<div class="loading-bar">
<img src="/mnt/data/IMG_8386.png" style="width: 100%; height: 5px;"/>
</div>
</div>

<div class="loading-screen">
<img alt="BurgerCoin Logo" src="/mnt/data/IMG_8388.jpeg" style="width: 100px; height: 100px; margin-bottom: 20px;"/>
<p>Caricamento...</p>
<div class="loading-bar" style="width: 50%; height: 5px; background-color: #ffca28; margin: 20px auto;"></div>
</div>
<div class_="loading-screen">Caricamento...</div>
<div class="app">
<!-- TOP BAR -->
<div class="topbar">
<div class="pill"><span aria-hidden="true" class="icon">üçî</span> <b id="coins">0</b></div>
<div class="pill">‚ö° <b id="energy">0</b></div>
<div class="pill">üíé <b id="gems">0</b></div>
<div class="pill" id="username">üë§ Ospite</div>
<div class_="pill">Referral</div></div>
<!-- CABINET -->
<div class="cabinet">
<div class="titleBadge">BURGER COIN</div>
<div class="panel">
<div class="progress" style="margin-bottom:8px">
<div class="badge">Lvl <b id="level">1</b></div>
<div class="track"><div class="bar" id="xpbar"></div></div>
<div class="badge"><b id="xptext">0/100 XP</b></div>
</div>
<div class="tapCard" id="tapArea">
<!-- Cartoon Burger Coin SVG -->
<div aria-hidden="true" class="burger-wrap">
<svg class="burger-coin" href="/mnt/data/IMG_8388.jpeg" role="img" viewbox="0 0 600 600" xmlns="http://www.w3.org/2000/svg">
<!-- coin base -->
<defs>
<radialgradient cx="35%" cy="30%" id="gCoin" r="70%">
<stop offset="0%" stop-color="#fff1b2"></stop>
<stop offset="55%" stop-color="#ffd54d"></stop>
<stop offset="100%" stop-color="#ffb300"></stop>
</radialgradient>
<radialgradient cx="30%" cy="30%" id="gShine" r="50%">
<stop offset="0%" stop-color="rgba(255,255,255,.7)"></stop>
<stop offset="100%" stop-color="rgba(255,255,255,0)"></stop>
</radialgradient>
</defs>
<circle cx="300" cy="300" fill="url(#gCoin)" r="220" stroke="#c78812" stroke-width="18"></circle>
<circle cx="300" cy="300" fill="url(#gShine)" r="180"></circle>
<!-- burger cartoon -->
<g transform="translate(120,180)">
<!-- top bun -->
<path d="M60 70 q120 -90 240 0 q10 10 10 25 v8 h-260 v-8 q0-15 10-25z" fill="#f6b26b" stroke="#c8833b" stroke-width="6"></path>
<!-- sesame -->
<g fill="#fff6d5" stroke="#e8cf88" stroke-width="2">
<ellipse cx="120" cy="65" rx="10" ry="6"></ellipse>
<ellipse cx="160" cy="55" rx="10" ry="6" transform="rotate(-10 160 55)"></ellipse>
<ellipse cx="200" cy="60" rx="10" ry="6"></ellipse>
<ellipse cx="240" cy="65" rx="10" ry="6"></ellipse>
<ellipse cx="280" cy="55" rx="10" ry="6"></ellipse>
</g>
<!-- lettuce -->
<path d="M55 118 q30 16 60 0 t60 0 t60 0 t60 0 q30 16 60 0 v20 H55z" fill="#7fd35b" stroke="#53a13b" stroke-width="6"></path>
<!-- tomato -->
<rect fill="#ff6b6b" height="22" rx="10" stroke="#c23b3b" stroke-width="6" width="300" x="70" y="138"></rect>
<!-- cheese -->
<path d="M80 165 h280 l-30 26 -30 -22 -40 22 -40 -18 -30 18z" fill="#ffd54d" stroke="#caa320" stroke-width="6"></path>
<!-- patty -->
<rect fill="#8b4513" height="40" rx="20" stroke="#5f2e0d" stroke-width="6" width="300" x="70" y="188"></rect>
<!-- bottom bun -->
<rect fill="#f4b183" height="40" rx="20" stroke="#bf7f3f" stroke-width="6" width="320" x="60" y="225"></rect>
<!-- cute face -->
<circle cx="170" cy="205" fill="#1b1b1b" r="10"></circle>
<circle cx="290" cy="205" fill="#1b1b1b" r="10"></circle>
<path d="M200 215 q50 20 100 0" fill="none" stroke="#1b1b1b" stroke-linecap="round" stroke-width="6"></path>
</g>
</svg>
</div>
<button class="tapBtn" id="tapBtn"><img alt="BurgerCoin Logo" src="/mnt/data/IMG_8388.jpeg" style="width: 80px; height: 80px; cursor: pointer;"/></button>
<div class="fly" id="fly"></div>
</div>
<div class="grid2" style="margin-top:10px">
<div class="badge">üí• Combo: <b id="combo">x1</b></div>
<div class="badge">‚è≥ Offline: <b id="offline">0s</b></div>
</div>
</div>
</div>
<!-- TABS -->
<div class="tabs">
<div class="tab active" data-view="home">üè† Home</div>
<div class="tab" data-view="upgrades">üõí Upgrades</div>
<div class="tab" data-view="missions">üìú Missioni</div>
<div class="tab" data-view="wheel">üé° Wheel</div>
<div class="tab" data-view="rank">üèÜ Classifica</div>
</div>
<!-- VIEWS -->
<div class="view active" id="view-home">
<div class="card center small">Tocca il <b>BurgerCoin</b> per guadagnare. Compra upgrade, completa missioni e gira la Wheel!</div>
<div class="card grid2">
<div>üéÅ Daily: <b id="dailyInfo">Disponibile</b></div>
<button class="btn" id="claimDaily">Claim</button>
</div>
<div class="card grid2">
<div>üöÄ Boost x2 (60s)</div>
<button class="btn" id="boost">Usa</button>
</div>
</div>
<div class="view" id="view-upgrades">
<div id="shopList"></div>
</div>
<div class="view" id="view-missions">
<div id="missionList"></div>
</div>
<div class="view" id="view-wheel">
<div class="wheelWrap">
<div class="pointer"></div>
<div class="wheel" id="wheel"></div>
<div class="center" style="margin-top:10px">
<div class="small">Gira la ruota (1 gemma)</div>
<button class="btn" id="spinWheel">Gira</button>
</div>
</div>
</div>
<div class="view" id="view-rank">
<div class="card">
<div class="small">Classifica Globale (demo)</div>
<div id="rankTable"></div>
</div>
</div>
</div>
<div class="toast" id="toast"></div>
<script>
/* ===== Utils ===== */
const $ = s => document.querySelector(s);
const $$ = s => [...document.querySelectorAll(s)];
const clamp = (n,min,max)=> Math.max(min, Math.min(max,n));
const now = ()=> Date.now();
const fmt = n => (n>=1e12? (n/1e12).toFixed(2)+"T" : n>=1e9? (n/1e9).toFixed(2)+"B" : n>=1e6? (n/1e6).toFixed(2)+"M" : n>=1e3? (n/1e3).toFixed(1)+"K" : Math.floor(n).toString());
function toast(msg){ const t=$("#toast"); t.textContent=msg; t.classList.add("show"); setTimeout(()=>t.classList.remove("show"),1800); }

/* Telegram hook (safe fallback) */
try{
  if(window.Telegram && Telegram.WebApp){
    Telegram.WebApp.ready();
    const u = Telegram.WebApp.initDataUnsafe?.user?.username;
    if(u) $("#username").textContent = "@" + u;
  }
}catch(e){}

/* ===== Game State ===== */
const STATE_KEY = "burgercoin-game-v1";
const DefaultState = {
  coins: 150,
  energy: 60, maxEnergy: 60, energyRegen: 1, energyEveryMs: 3500,
  gems: 5,
  level: 1, xp: 0, xpMax: 120,
  combo: 1, comboTimer: 0, comboMs: 5000,
  boostMs: 0,
  pass: false,
  lastSeen: now(),
  daily: { last: 0, streak: 0 },
  upgrades: {
    finger: {lvl:0},
    miner: {lvl:0},
    crit: {lvl:0},
    energy: {lvl:0},
    offline: {lvl:0}
  },
  missions: [
    {id:"taps", name:"Fai 100 tap", cur:0, max:100, reward:200},
    {id:"coins", name:"Raggiungi 10K coin", cur:0, max:10000, reward:5, type:"gems"},
    {id:"level", name:"Arriva al livello 5", cur:1, max:5, reward:1200}
  ],
  wheelCooldown: 0
};
let S = JSON.parse(localStorage.getItem(STATE_KEY) || "null") || DefaultState;
function save(){ localStorage.setItem(STATE_KEY, JSON.stringify(S)); }

/* ===== Shop & Economy ===== */
const Shop = [
  {id:"finger", name:"Dito Potenziato", desc:"+1 coin per tap", base:30, grow:1.45},
  {id:"miner",  name:"Auto-Miner", desc:"+1 coin/s", base:120, grow:1.55},
  {id:"crit",   name:"Colpi Critici", desc:"5% crit x lvl (x3)", base:140, grow:1.6},
  {id:"energy", name:"Batteria", desc:"+10 max energia + regen", base:100, grow:1.5},
  {id:"offline",name:"Guadagni Offline", desc:"+10% /lvl (max 8h)", base:160, grow:1.6}
];
const EMOJI = {finger:"üëâ", miner:"‚õèÔ∏è", crit:"üí•", energy:"üîã", offline:"üåô"};

/* ===== Render ===== */
function renderTop(){
  $("#coins").textContent = fmt(S.coins);
  $("#energy").textContent = Math.floor(S.energy);
  $("#gems").textContent = S.gems;
  $("#level").textContent = S.level;
  $("#xptext").textContent = S.xp + "/" + S.xpMax + " XP";
  $("#xpbar").style.width = (100*S.xp/S.xpMax) + "%";
  $("#combo").textContent = "x" + S.combo.toFixed(2);
}
function renderDaily(){
  const day = 24*3600*1000;
  const available = (now() - S.daily.last) > day;
  $("#dailyInfo").textContent = available ? "Disponibile" : "Torna domani";
  $("#claimDaily").disabled = !available;
}
function renderShop(){
  const wrap = $("#shopList"); wrap.innerHTML = "";
  Shop.forEach(item=>{
    const lvl = S.upgrades[item.id]?.lvl || 0;
    const price = Math.floor(item.base*Math.pow(item.grow,lvl));
    const div = document.createElement("div");
    div.className = "shopItem";
    div.innerHTML = `
      <div style="font-size:24px">${EMOJI[item.id]}</div>
      <div><b>${item.name} (Lv ${lvl})</b><div class="small">${item.desc}</div></div>
      <div class="right">
        <div class="small">Costo</div>
        <div>üçî <b>${price}</b></div>
        <button class="btn buy" data-id="${item.id}" ${S.coins<price?'disabled':''}>Compra</button>
      </div>
    `;
    wrap.appendChild(div);
  });
  wrap.querySelectorAll(".buy").forEach(b=> b.onclick = ()=>buy(b.dataset.id));
}
function renderMissions(){
  const wrap = $("#missionList"); wrap.innerHTML = "";
  S.missions.forEach(m=>{
    const p = clamp(m.cur/m.max,0,1);
    const done = m.cur>=m.max;
    const rewardStr = m.type==="gems" ? (m.reward+"üíé") : ("üçî "+m.reward);
    const div = document.createElement("div");
    div.className = "mission";
    div.innerHTML = `
      <div style="font-size:22px">üìú</div>
      <div style="flex:1">
        <b>${m.name}</b>
        <div class="small">${m.cur}/${m.max} ‚Ä¢ Ricompensa: <b>${rewardStr}</b></div>
        <div class="prog"><div style="width:${p*100}%"></div></div>
      </div>
      <button class="btn claim" ${done?'':'disabled'} data-id="${m.id}">Claim</button>
    `;
    wrap.appendChild(div);
  });
  wrap.querySelectorAll(".claim").forEach(b=> b.onclick = ()=>claimMission(b.dataset.id));
}
function renderRank(){
  const wrap = $("#rankTable"); wrap.innerHTML = "";
  const demo = [
    ["1","@elon",9876543],
    ["2","@vitalik",4200000],
    ["3","@satoshi",2100000],
    ["4","@you",S.coins]
  ];
  demo.forEach(r=>{
    const row = document.createElement("div");
    row.className = "tr";
    row.innerHTML = `<div><b>#${r[0]}</b></div><div>${r[1]}</div><div>üçî <b>${fmt(r[2])}</b></div>`;
    wrap.appendChild(row);
  });
}
function renderAll(){ renderTop(); renderDaily(); renderShop(); renderMissions(); renderRank(); }
renderAll();

/* ===== Mechanics ===== */
function tap(){
  if(S.energy<1){ toast("Energia esaurita üîã"); return; }
  S.energy -= 1;

  let perTap = 1 + (S.upgrades.finger.lvl||0);
  if(S.pass) perTap *= 1.1;
  perTap *= S.combo;
  if(S.boostMs>0) perTap *= 2;

  // crit x3
  const critChance = (S.upgrades.crit.lvl||0)*0.05;
  const crit = Math.random() < critChance;
  if(crit) perTap *= 3;

  S.coins += perTap;
  S.xp += 2;
  const mt = S.missions.find(m=>m.id==="taps"); if(mt) mt.cur++;

  if(S.xp>=S.xpMax){
    S.level++; S.xp -= S.xpMax; S.xpMax = Math.floor(S.xpMax*1.25);
    toast("LEVEL UP! üî•");
  }

  S.combo = clamp(S.combo+0.02,1,5);
  S.comboTimer = S.comboMs;

  fly(`+${fmt(perTap)}${crit?' üí•':''}`);
  renderTop(); save();
}

function fly(text){
  const f=$("#fly");
  f.textContent = text;
  f.animate(
    [
      {opacity:0, transform:"translate(-50%,-50%) translateY(10px)"},
      {opacity:1, transform:"translate(-50%,-50%) translateY(-6px)"},
      {opacity:0, transform:"translate(-50%,-50%) translateY(-18px)"}
    ],
    {duration:650, easing:"ease-out"}
  );
}

/* Timers: energy regen, combo decay, miner, offline label */
let lastTick = now();
function tick(){
  const t = now();
  const dt = t - lastTick; lastTick = t;

  // energy regen
  S._e = (S._e||0) + dt;
  while(S._e >= S.energyEveryMs){
    S._e -= S.energyEveryMs;
    S.energy = clamp(S.energy + S.energyRegen, 0, S.maxEnergy);
  }

  // combo decay
  if(S.comboTimer>0){ S.comboTimer -= dt; if(S.comboTimer<=0){ S.combo=1; } }

  // boost timer
  if(S.boostMs>0){ S.boostMs -= dt; if(S.boostMs<0) S.boostMs=0; }

  // miner passive
  const miner = S.upgrades.miner.lvl||0;
  if(miner>0){
    S._m = (S._m||0) + dt;
    while(S._m>=1000){
      S._m -= 1000;
      let gain = 1*miner;
      if(S.pass) gain *= 1.1;
      S.coins += gain;
    }
  }

  // update offline label
  $("#offline").textContent = Math.floor((t - S.lastSeen)/1000) + "s";

  renderTop();
  save();
  requestAnimationFrame(tick);
}
requestAnimationFrame(tick);

/* Offline earnings on load */
(function handleOffline(){
  const elapsed = now() - S.lastSeen;
  if(elapsed>5000){
    const hours = Math.min(8, elapsed/3600000);
    const mult = 0.1 * (S.upgrades.offline.lvl||0);
    const miner = (S.upgrades.miner.lvl||0);
    const basePerSec = miner;
    const reward = basePerSec * hours * 3600 * mult;
    if(reward>0){ S.coins += reward; toast("Guadagni offline: +" + fmt(reward)); }
  }
  S.lastSeen = now();
  save();
})();

/* Actions */
$("#tapBtn").onclick = tap;

$("#claimDaily").onclick = ()=>{
  const day = 24*3600*1000;
  if(now()-S.daily.last < day) return;
  S.daily.last = now();
  S.daily.streak = Math.min(30, S.daily.streak+1);
  const reward = 80 * S.daily.streak;
  S.coins += reward;
  toast("Daily +"+fmt(reward)+" (streak "+S.daily.streak+")");
  renderDaily(); renderTop(); save();
};

$("#boost").onclick = ()=>{
  if(S.boostMs>0){ toast("Boost gi√† attivo"); return; }
  if(S.gems<1){ toast("Servono gemme üíé"); return; }
  S.gems -= 1;
  S.boostMs = 60000;
  toast("Boost x2 per 60s!");
  renderTop(); save();
};

/* Shop */
function buy(id){
  const item = Shop.find(s=>s.id===id);
  const lvl = S.upgrades[id].lvl||0;
  const price = Math.floor(item.base*Math.pow(item.grow,lvl));
  if(S.coins<price){ toast("Monete insufficienti"); return; }
  S.coins -= price;
  S.upgrades[id].lvl = lvl+1;
  if(id==="energy"){ S.maxEnergy += 10; S.energyRegen += 0.2; }
  toast(item.name+" Lv "+(lvl+1)+" acquistato!");
  renderTop(); renderShop(); save();
}

/* Missions claim */
function claimMission(id){
  const m = S.missions.find(x=>x.id===id);
  if(!m || m.cur<m.max) return;
  if(m.type==="gems"){ S.gems += m.reward; } else { S.coins += m.reward; }
  toast("Ricompensa missione: +" + (m.type==="gems" ? (m.reward+"üíé") : (m.reward+" üçî")));
  // regenerate simple loop missions
  if(m.id!=="level"){
    m.cur = 0;
    m.max = Math.floor(m.max*1.8);
    m.reward = Math.floor(m.reward*1.8);
  }
  renderMissions(); renderTop(); save();
}

/* Wheel */
$("#spinWheel").onclick = ()=>{
  if(S.gems<1){ toast("Serve 1 gemma"); return; }
  if(S.wheelCooldown>now()){ toast("Attendi..."); return; }
  S.gems -= 1; renderTop();
  const wheel = $("#wheel");
  const deg = 360*5 + Math.floor(Math.random()*360);
  wheel.style.transition = "transform 2.2s cubic-bezier(.2,.8,.2,1)";
  wheel.style.transform = `rotate(${deg}deg)`;
  setTimeout(()=>{
    const sector = Math.floor(((deg%360)+22.5)/45)%8;
    const rewards = [100, 1, 300, 2, 150, 1, 500, 3]; // coins/gems alternati
    let reward = rewards[sector];
    if(sector%2===0){ S.coins += reward; toast("Ruota: +"+fmt(reward)+" üçî"); }
    else{ S.gems += reward; toast("Ruota: +"+reward+"üíé"); }
    S.wheelCooldown = now()+2000;
    renderTop(); save();
  }, 2300);
};

/* Tabs */
$$(".tab").forEach(t=> t.onclick = ()=>{
  $$(".tab").forEach(x=>x.classList.remove("active"));
  t.classList.add("active");
  const id = t.dataset.view;
  $$(".view").forEach(v=> v.classList.remove("active"));
  $("#view-"+id).classList.add("active");
});

/* Anti-cheat rudimentale */
(function antiCheat(){
  const origSetItem = localStorage.setItem;
  localStorage.setItem = function(k,v){
    if(k===STATE_KEY){
      try{ const data=JSON.parse(v); if(data.coins>1e15) return; }catch(e){}
    }
    return origSetItem.apply(this, arguments);
  };
})();

/* Mission hooks periodic */
setInterval(()=>{
  const mc = S.missions.find(x=>x.id==="coins"); if(mc){ mc.cur = Math.max(mc.cur, Math.floor(S.coins)); }
  const ml = S.missions.find(x=>x.id==="level"); if(ml){ ml.cur = Math.max(ml.cur, S.level); }
  renderMissions(); save();
}, 1500);

/* Save on unload */
window.addEventListener("beforeunload", ()=>{ S.lastSeen = now(); save(); });
</script>
<script>
  const logo = document.querySelector('#tapBtn img');
  logo.addEventListener('click', () => {
    logo.style.transform = 'scale(1.2)';
    logo.style.transition = 'transform 0.1s';
    const audio = new Audio('/mnt/data/sound_effect.mp3');
    audio.play();
    setTimeout(() => {
      logo.style.transform = 'scale(1)';
    }, 100);
  });
</script>

<script>
  const logo = document.querySelector('#tapBtn img');
  logo.addEventListener('click', () => {
    logo.style.transform = 'scale(1.2)';
    logo.style.transition = 'transform 0.1s';
    const audio = new Audio('/mnt/data/sound_effect.mp3');
    audio.play();
    setTimeout(() => {
      logo.style.transform = 'scale(1)';
    }, 100);
  });
</script>
</body>
</html>