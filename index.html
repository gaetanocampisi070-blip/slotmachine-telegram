<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<title>BurgerCoin — Idle Tap WebApp</title>
<meta name="theme-color" content="#0a2a68">
<style>
/* ===== THEME ===== */
:root{
  --bg:#0a2a68;
  --sky1:#224aa2;
  --sky2:#081b43;
  --panel:#121b36;
  --panel2:#1c2d5b;
  --wood:#a66b2d;
  --wood2:#8a541f;
  --gold1:#ffe082;
  --gold2:#ffca28;
  --gold3:#ffb300;
  --mint1:#b2ff59;
  --mint2:#69f0ae;
  --text:#fff;
  --muted:#c7d2fe;
  --shadow: 0 18px 32px rgba(0,0,0,.46);
  --inset: inset 0 -2px 0 rgba(0,0,0,.2), inset 0 2px 0 rgba(255,255,255,.12);
}

*{box-sizing:border-box}
html,body{height:100%;margin:0}
body{
  background: radial-gradient(120% 120% at 50% 0%, var(--sky1) 0%, var(--bg) 55%, var(--sky2) 100%);
  color:var(--text);
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Inter, Roboto, "Helvetica Neue", Arial, system-ui, sans-serif;
  -webkit-font-smoothing: antialiased;
  text-rendering: optimizeLegibility;
}

.app{
  max-width: 520px;
  margin: 0 auto;
  min-height: 100dvh;
  display:flex;
  flex-direction: column;
  gap: 12px;
  padding: 10px 10px 20px;
}

/* TOP BAR */
.topbar{
  display:flex; align-items:center; gap:8px; flex-wrap:wrap;
  padding: 10px;
  background: linear-gradient(180deg, var(--panel2), var(--panel));
  border-radius: 16px;
  box-shadow: var(--shadow);
  border: 1px solid rgba(255,255,255,.06);
}
.pill{
  display:flex; align-items:center; gap:8px;
  background: rgba(10,15,35,.8);
  border:1px solid rgba(255,255,255,.08);
  padding:8px 12px;
  border-radius:999px;
  box-shadow: var(--inset);
  white-space:nowrap;
}
.pill b{font-variant-numeric: tabular-nums;}
.icon{width:18px;height:18px;vertical-align:middle;display:inline-block}

/* CABINET (wood frame) */
.cabinet{
  position:relative;
  background: linear-gradient(180deg, #c47b33 0%, var(--wood) 60%, var(--wood2) 100%);
  border-radius: 28px;
  padding: 16px 12px 18px;
  box-shadow: var(--shadow);
}
.titleBadge{
  position:absolute; top:-18px; left:50%; transform:translateX(-50%);
  background: linear-gradient(180deg, var(--gold1), var(--gold2) 60%, var(--gold3));
  color:#4a3000;
  font-weight:900; letter-spacing:.6px;
  padding:8px 16px; border-radius:999px;
  border:2px solid rgba(0,0,0,.18);
  text-shadow: 0 2px 0 rgba(255,255,255,.5);
  box-shadow: var(--shadow);
}
.panel{
  background: linear-gradient(180deg, #213055, #121b36);
  border-radius: 22px;
  padding: 12px;
  border:1px solid rgba(255,255,255,.06);
  box-shadow: var(--inset), var(--shadow);
}

/* XP */
.progress{display:flex; align-items:center; gap:10px}
.track{flex:1; height:14px; border-radius:999px; background: rgba(255,255,255,.08); box-shadow: inset 0 2px 4px rgba(0,0,0,.35); overflow:hidden}
.bar{height:100%; background: linear-gradient(90deg, var(--mint2), var(--mint1)); width:0%}
.badge{background:#0f1730;border:1px solid rgba(255,255,255,.1); padding:6px 10px; border-radius:12px}

/* Tap area */
.tapCard{
  margin-top:10px;
  display:grid; place-items:center;
  background: radial-gradient(60% 60% at 50% 35%, #22345f 0%, #121b36 60%);
  border-radius: 18px;
  border:1px solid rgba(255,255,255,.05);
  padding: 14px;
  position:relative; overflow:hidden;
  min-height: 230px;
}
.tapBtn{
  font-weight:900; font-size:22px; letter-spacing:.6px;
  padding:16px 26px; border-radius: 22px; border:none;
  color:#4a3000;
  background: linear-gradient(180deg, var(--gold1), var(--gold2) 60%, var(--gold3));
  box-shadow: 0 14px 24px rgba(0,0,0,.35), inset 0 3px 0 rgba(255,255,255,.85);
  transition: transform .05s ease, box-shadow .05s ease;
  margin-top: 150px;
}
.tapBtn:active{ transform: translateY(2px); box-shadow: 0 10px 18px rgba(0,0,0,.35), inset 0 2px 0 rgba(255,255,255,.6); }
.fly{ position:absolute; left:50%; top:56%; transform:translate(-50%,-50%); font-weight:900; text-shadow:0 2px 0 rgba(0,0,0,.3); opacity:0; }

/* Burger mascot */
.burger-wrap{ position:absolute; top:6px; left:50%; transform:translateX(-50%); width: 74%; max-width: 360px; user-select:none; pointer-events:none; filter: drop-shadow(0 10px 18px rgba(0,0,0,.35)); }
.burger-coin{ width:100%; height:auto; display:block; }

/* Tabs */
.tabs{ display:flex; gap:8px; margin-top:10px; flex-wrap:wrap }
.tab{ flex:1; text-align:center; padding:10px 8px; border-radius:12px; background: linear-gradient(180deg, #22345f, #121b36); border:1px solid rgba(255,255,255,.06); cursor:pointer; user-select:none }
.tab.active{ outline:2px solid #89f; }
.view{ display:none }
.view.active{ display:block }

/* Cards & lists */
.card{ background: linear-gradient(180deg, #22345f, #121b36); border:1px solid rgba(255,255,255,.06); border-radius: 16px; padding:12px; margin-bottom:10px }
.small{ font-size:12px; opacity:.85 }
.center{ text-align:center }
.grid2{ display:grid; grid-template-columns:1fr auto; gap:10px; align-items:center }
.btn{ background: linear-gradient(180deg, #94b4ff, #5b7aff); border:none; color:white; font-weight:700; padding:8px 12px; border-radius:10px; box-shadow: var(--shadow); cursor:pointer }
.btn:disabled{ opacity:.55; filter:grayscale(30%) }

.shopItem{
  display:flex; align-items:center; gap:10px;
  background: linear-gradient(180deg, #22345f, #111a34);
  border:1px solid rgba(255,255,255,.05);
  border-radius:14px; padding:10px; margin-bottom:8px;
}
.shopItem .right{ margin-left:auto; text-align:right }

.mission{ display:flex; align-items:center; gap:10px; padding:10px; background: linear-gradient(180deg, #22345f, #111a34); border:1px solid rgba(255,255,255,.05); border-radius:12px; margin-bottom:8px }
.mission .prog{ flex:1; height:8px; border-radius:999px; background:rgba(255,255,255,.1); overflow:hidden }
.mission .prog>div{ height:100%; background:linear-gradient(90deg, #8ae, #cdf) }

/* Wheel */
.wheelWrap{ display:grid; place-items:center; padding:10px }
.wheel{ width:250px; height:250px; border-radius:50%; background:conic-gradient(#ffd54d 0 45deg,#fdf 45deg 90deg,#9ff 90deg 135deg,#b2ff59 135deg 180deg,#ffa 180deg 225deg,#cfd 225deg 270deg,#fc9 270deg 315deg,#aff 315deg 360deg); box-shadow: var(--shadow); position:relative }
.wheel::after{ content:""; position:absolute; inset:10px; border-radius:50%; background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.6), rgba(255,255,255,0) 60%); }
.pointer{ width:0; height:0; border-left:14px solid transparent; border-right:14px solid transparent; border-bottom:18px solid #ff5252; margin-top:6px }

/* Leaderboard */
.table{ width:100%; border-collapse:separate; border-spacing:0 8px }
.tr{ display:grid; grid-template-columns:32px 1fr auto; gap:10px; align-items:center; background: linear-gradient(180deg, #1f2f58, #0f1730); border:1px solid rgba(255,255,255,.06); padding:8px 10px; border-radius:10px }

/* Toast */
.toast{ position:fixed; left:50%; bottom:18px; transform:translateX(-50%); background:#111a34; border:1px solid rgba(255,255,255,.1); color:#fff; padding:10px 14px; border-radius:12px; box-shadow: var(--shadow); opacity:0; pointer-events:none; transition:.3s opacity, .3s transform; z-index:10 }
.toast.show{ opacity:1; transform:translateX(-50%) translateY(-6px) }

/* Splash screen */
#splash {
  position: fixed; inset: 0;
  background: radial-gradient(140% 140% at 50% 0%, #2b3f78 0%, #111a34 70%);
  display:flex; align-items:center; justify-content:center; flex-direction:column;
  z-index: 9999; transition: opacity .6s ease;
}
.splash-content{ text-align:center; color:#fff; }
.splash-logo{ font-weight:900; font-size:34px; letter-spacing:.8px; margin:10px 0 14px }
.splash-card{ background: linear-gradient(180deg, #22345f, #121b36); border:1px solid rgba(255,255,255,.1); padding:18px 18px 16px; border-radius:20px; box-shadow: var(--shadow); }
.splash-progress{ width:260px; height:18px; border-radius:12px; overflow:hidden; background: rgba(255,255,255,.18); margin-top:12px; box-shadow: inset 0 2px 6px rgba(0,0,0,.35)}
#progress-bar{ height:100%; width:0%; background: linear-gradient(90deg, var(--gold1), var(--gold3)); transition: width .25s ease }
.smallnote{ font-size:12px; opacity:.8; margin-top:6px }

/* Accessibility */
button:focus-visible, .tab:focus-visible { outline: 2px solid #86a7ff; outline-offset: 2px; }

@media (max-width: 360px){
  .tapBtn{ margin-top:130px }
}
</style>
</head>
<body>

<!-- SPLASH SCREEN -->
<div id="splash" role="dialog" aria-label="Loading">
  <div class="splash-content">
    <div class="splash-card">
      <!-- Cartoon Burger Mascot SVG (clean + cute) -->
      <svg width="220" height="200" viewBox="0 0 300 260" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
        <defs>
          <linearGradient id="g1" x1="0" x2="0" y1="0" y2="1">
            <stop offset="0%" stop-color="#ffd54d"/><stop offset="100%" stop-color="#ffb300"/>
          </linearGradient>
        </defs>
        <!-- Face -->
        <g transform="translate(20,10)">
          <!-- Top bun -->
          <path d="M20 90 Q130 10 240 90 Q245 100 245 110 L245 120 L20 120 L20 110 Q20 100 25 90" fill="#f6b26b" stroke="#c8833b" stroke-width="4" />
          <!-- Sesame seeds -->
          <g fill="#fff6d5" stroke="#e8cf88" stroke-width="1.5">
            <ellipse cx="80" cy="75" rx="7" ry="4"/><ellipse cx="110" cy="65" rx="7" ry="4" transform="rotate(-12 110 65)"/>
            <ellipse cx="150" cy="68" rx="7" ry="4"/><ellipse cx="190" cy="73" rx="7" ry="4"/><ellipse cx="220" cy="63" rx="7" ry="4"/>
          </g>
          <!-- Lettuce -->
          <path d="M22 120 q15 10 30 0 t30 0 t30 0 t30 0 t30 0 t30 0 q15 10 30 0 v16 H22z" fill="#7fd35b" stroke="#53a13b" stroke-width="4"/>
          <!-- Tomato -->
          <rect x="30" y="136" width="210" height="16" rx="8" fill="#ff6b6b" stroke="#c23b3b" stroke-width="4"/>
          <!-- Cheese -->
          <path d="M34 152 H236 L212 168 L182 154 L150 170 L120 156 L92 170 Z" fill="#ffd54d" stroke="#caa320" stroke-width="4"/>
          <!-- Patty -->
          <rect x="30" y="170" width="210" height="28" rx="14" fill="#8b4513" stroke="#5f2e0d" stroke-width="4"/>
          <!-- Bottom bun -->
          <rect x="22" y="198" width="226" height="26" rx="13" fill="#f4b183" stroke="#bf7f3f" stroke-width="4"/>
          <!-- Cute face -->
          <circle cx="110" cy="182" r="6" fill="#1b1b1b"/>
          <circle cx="182" cy="182" r="6" fill="#1b1b1b"/>
          <path d="M126 188 q24 12 48 0" fill="none" stroke="#1b1b1b" stroke-width="4" stroke-linecap="round"/>
        </g>
      </svg>
      <div class="splash-logo">🍔 BurgerCoin</div>
      <div class="splash-progress"><div id="progress-bar"></div></div>
      <div class="smallnote">Loading resources…</div>
    </div>
  </div>
</div>

<!-- TOP BAR -->
<div class="app" id="app" aria-hidden="true">
  <div class="topbar">
    <div class="pill"><span class="icon" aria-hidden="true">🍔</span> <b id="coins">0</b></div>
    <div class="pill">⚡ <b id="energy">0</b></div>
    <div class="pill">💎 <b id="gems">0</b></div>
    <div class="pill" id="username">👤 Guest</div>
  </div>

  <!-- CABINET -->
  <div class="cabinet">
    <div class="titleBadge">BURGER COIN</div>
    <div class="panel">
      <div class="progress" style="margin-bottom:8px">
        <div class="badge">Lvl <b id="level">1</b></div>
        <div class="track"><div class="bar" id="xpbar"></div></div>
        <div class="badge"><b id="xptext">0/100 XP</b></div>
      </div>

      <div class="tapCard" id="tapArea">
        <!-- Coin + mascot, centered better -->
        <div class="burger-wrap" aria-hidden="true">
          <svg class="burger-coin" viewBox="0 0 600 600" xmlns="http://www.w3.org/2000/svg" role="img">
            <!-- coin base -->
            <defs>
              <radialGradient id="gCoin" cx="35%" cy="30%" r="70%">
                <stop offset="0%" stop-color="#fff1b2"/>
                <stop offset="55%" stop-color="#ffd54d"/>
                <stop offset="100%" stop-color="#ffb300"/>
              </radialGradient>
              <radialGradient id="gShine" cx="30%" cy="30%" r="50%">
                <stop offset="0%" stop-color="rgba(255,255,255,.7)"/>
                <stop offset="100%" stop-color="rgba(255,255,255,0)"/>
              </radialGradient>
            </defs>
            <circle cx="300" cy="300" r="220" fill="url(#gCoin)" stroke="#c78812" stroke-width="18"/>
            <circle cx="300" cy="300" r="180" fill="url(#gShine)"/>
            <!-- burger cartoon - recentred inside coin -->
            <g transform="translate(110,150)">
              <!-- top bun -->
              <path d="M60 70 q120 -90 240 0 q10 10 10 25 v8 h-260 v-8 q0-15 10-25z" fill="#f6b26b" stroke="#c8833b" stroke-width="6"/>
              <!-- sesame -->
              <g fill="#fff6d5" stroke="#e8cf88" stroke-width="2">
                <ellipse cx="120" cy="65" rx="10" ry="6"/>
                <ellipse cx="160" cy="55" rx="10" ry="6" transform="rotate(-10 160 55)"/>
                <ellipse cx="200" cy="60" rx="10" ry="6"/>
                <ellipse cx="240" cy="65" rx="10" ry="6"/>
                <ellipse cx="280" cy="55" rx="10" ry="6"/>
              </g>
              <!-- lettuce -->
              <path d="M55 118 q30 16 60 0 t60 0 t60 0 t60 0 q30 16 60 0 v20 H55z" fill="#7fd35b" stroke="#53a13b" stroke-width="6"/>
              <!-- tomato -->
              <rect x="70" y="138" width="300" height="22" rx="10" fill="#ff6b6b" stroke="#c23b3b" stroke-width="6"/>
              <!-- cheese -->
              <path d="M80 165 h280 l-30 26 -30 -22 -40 22 -40 -18 -30 18z" fill="#ffd54d" stroke="#caa320" stroke-width="6"/>
              <!-- patty -->
              <rect x="70" y="188" width="300" height="40" rx="20" fill="#8b4513" stroke="#5f2e0d" stroke-width="6"/>
              <!-- bottom bun -->
              <rect x="60" y="225" width="320" height="40" rx="20" fill="#f4b183" stroke="#bf7f3f" stroke-width="6"/>
              <!-- cute face -->
              <circle cx="170" cy="205" r="10" fill="#1b1b1b"/>
              <circle cx="290" cy="205" r="10" fill="#1b1b1b"/>
              <path d="M200 215 q50 20 100 0" fill="none" stroke="#1b1b1b" stroke-width="6" stroke-linecap="round"/>
            </g>
          </svg>
        </div>

        <button class="tapBtn" id="tapBtn">TAP TO EARN</button>
        <div class="fly" id="fly"></div>
      </div>

      <div class="grid2" style="margin-top:10px">
        <div class="badge">💥 Combo: <b id="combo">x1</b></div>
        <div class="badge">⏳ Offline: <b id="offline">0s</b></div>
      </div>
    </div>
  </div>

  <!-- TABS -->
  <div class="tabs">
    <div class="tab active" data-view="home">🏠 Home</div>
    <div class="tab" data-view="upgrades">🛒 Upgrades</div>
    <div class="tab" data-view="missions">📜 Missions</div>
    <div class="tab" data-view="wheel">🎡 Wheel</div>
    <div class="tab" data-view="rank">🏆 Leaderboard</div>
  </div>

  <!-- VIEWS -->
  <div class="view active" id="view-home">
    <div class="card center small">Tap the <b>BurgerCoin</b> to earn. Buy upgrades, complete missions and spin the wheel!</div>
    <div class="card grid2">
      <div>🎁 Daily: <b id="dailyInfo">Available</b></div>
      <button class="btn" id="claimDaily">Claim</button>
    </div>
    <div class="card grid2">
      <div>🚀 Boost x2 (60s)</div>
      <button class="btn" id="boost">Use</button>
    </div>
  </div>

  <div class="view" id="view-upgrades">
    <div id="shopList"></div>
  </div>

  <div class="view" id="view-missions">
    <div id="missionList"></div>
  </div>

  <div class="view" id="view-wheel">
    <div class="wheelWrap">
      <div class="pointer"></div>
      <div class="wheel" id="wheel"></div>
      <div style="margin-top:10px" class="center">
        <div class="small">Spin the wheel (1 gem)</div>
        <button class="btn" id="spinWheel">Spin</button>
      </div>
    </div>
  </div>

  <div class="view" id="view-rank">
    <div class="card">
      <div class="small">Global Leaderboard (daily shuffle)</div>
      <div id="rankTable"></div>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
/* ===== Utils ===== */
const $ = s => document.querySelector(s);
const $$ = s => [...document.querySelectorAll(s)];
const clamp = (n,min,max)=> Math.max(min, Math.min(max,n));
const now = ()=> Date.now();
const fmt = n => (n>=1e12? (n/1e12).toFixed(2)+"T" : n>=1e9? (n/1e9).toFixed(2)+"B" : n>=1e6? (n/1e6).toFixed(2)+"M" : n>=1e3? (n/1e3).toFixed(1)+"K" : Math.floor(n).toString());
function toast(msg){ const t=$("#toast"); t.textContent=msg; t.classList.add("show"); setTimeout(()=>t.classList.remove("show"),1800); }

/* ===== Simple WebAudio sounds (no files needed) ===== */
let AudioCtx, masterGain, musicStarted=false;
function initAudio(){
  if(AudioCtx) return;
  AudioCtx = new (window.AudioContext||window.webkitAudioContext)();
  masterGain = AudioCtx.createGain(); masterGain.gain.value = 0.15; masterGain.connect(AudioCtx.destination);
}
function blip(freq=440, dur=0.08, type="sine", vol=0.6){
  if(!AudioCtx) return;
  const o = AudioCtx.createOscillator();
  const g = AudioCtx.createGain();
  o.type = type; o.frequency.value = freq;
  g.gain.value = vol;
  o.connect(g); g.connect(masterGain);
  o.start();
  g.gain.exponentialRampToValueAtTime(0.0001, AudioCtx.currentTime + dur);
  o.stop(AudioCtx.currentTime + dur + 0.02);
}
function chord(freqs=[440,550,660], dur=0.5){
  if(!AudioCtx) return;
  const g = AudioCtx.createGain(); g.gain.value=.08; g.connect(masterGain);
  const nowt = AudioCtx.currentTime;
  freqs.forEach(f=>{
    const o=AudioCtx.createOscillator(); o.type="sine"; o.frequency.value=f;
    o.connect(g); o.start(nowt); o.stop(nowt+dur);
  });
}
function startIntroMusic(){
  if(musicStarted || !AudioCtx) return;
  musicStarted=true;
  // very simple looped arpeggio
  const g = AudioCtx.createGain(); g.gain.value=.06; g.connect(masterGain);
  function tone(seq){
    const o = AudioCtx.createOscillator(); o.type="triangle";
    o.frequency.setValueAtTime(seq.f, AudioCtx.currentTime);
    const eg = AudioCtx.createGain(); eg.gain.value=0.0; eg.connect(g);
    o.connect(eg); o.start();
    eg.gain.linearRampToValueAtTime(.8, AudioCtx.currentTime+0.05);
    eg.gain.exponentialRampToValueAtTime(0.001, AudioCtx.currentTime+seq.d-0.02);
    o.stop(AudioCtx.currentTime+seq.d);
  }
  let i=0;
  const notes=[261.6,329.6,392.0,523.3,392.0,329.6];
  setInterval(()=>{ tone({f:notes[i%notes.length], d:0.35}); i++; }, 360);
}

/* Telegram hook (safe fallback) */
try{
  if(window.Telegram && Telegram.WebApp){
    Telegram.WebApp.ready();
    const u = Telegram.WebApp.initDataUnsafe?.user?.username;
    if(u) $("#username").textContent = "@" + u;
  }
}catch(e){}

/* ===== Game State ===== */
const STATE_KEY = "burgercoin-game-v2";
const DefaultState = {
  coins: 150,
  energy: 60, maxEnergy: 60, energyRegen: 1, energyEveryMs: 3500,
  gems: 5,
  level: 1, xp: 0, xpMax: 120,
  combo: 1, comboTimer: 0, comboMs: 5000,
  boostMs: 0,
  pass: false,
  lastSeen: now(),
  daily: { last: 0, streak: 0 },
  upgrades: {
    finger: {lvl:0},
    miner: {lvl:0},
    crit: {lvl:0},
    energy: {lvl:0},
    offline: {lvl:0}
  },
  missions: [
    {id:"taps", name:"Do 100 taps", cur:0, max:100, reward:200},
    {id:"coins", name:"Reach 10K coins", cur:0, max:10000, reward:5, type:"gems"},
    {id:"level", name:"Get to level 5", cur:1, max:5, reward:1200}
  ],
  wheelCooldown: 0
};
let S = JSON.parse(localStorage.getItem(STATE_KEY) || "null") || DefaultState;
function save(){ localStorage.setItem(STATE_KEY, JSON.stringify(S)); }

/* ===== Shop & Economy ===== */
const Shop = [
  {id:"finger", name:"Power Finger", desc:"+1 coin per tap", base:30, grow:1.45},
  {id:"miner",  name:"Auto-Miner", desc:"+1 coin/s", base:120, grow:1.55},
  {id:"crit",   name:"Critical Hits", desc:"5% crit per lvl (x3)", base:140, grow:1.6},
  {id:"energy", name:"Battery", desc:"+10 max energy & regen", base:100, grow:1.5},
  {id:"offline",name:"Offline Gains", desc:"+10% /lvl (max 8h)", base:160, grow:1.6}
];
const EMOJI = {finger:"👉", miner:"⛏️", crit:"💥", energy:"🔋", offline:"🌙"};

/* ===== Leaderboard (50 fake daily + current user) ===== */
function generateFakeRankList(){
  const sample = [
    "@cryptoKing","@burgerLover","@coinMaster","@tapTap","@idlePro",
    "@fastClicker","@satoshiWannabe","@gemHunter","@level99","@burgerQueen",
    "@elTapador","@energyBoost","@missionMan","@wheelWizard","@comboLord",
    "@tapStorm","@coinFarmer","@gemCollector","@burgerBoss","@rankChaser",
    "@autoMiner","@clickMachine","@xpGrinder","@dailyStreak","@offlineHero",
    "@powerTap","@coinRain","@goldenTap","@levelUp","@boosted",
    "@coinzilla","@gigaTap","@luckySpin","@energySaver","@burgerTapper",
    "@theTapGod","@coinAddict","@missionHunter","@rankedUp","@burgerChain",
    "@idleKing","@cryptoTap","@coinRush","@gemTapper","@burgerX",
    "@supaTap","@megaClicker","@tapWarrior","@coinClicker","@burgero",
    "@tapNinja","@clickWizard","@comboBee","@tokenTiger","@diamondDuck",
    "@stakingSam","@alphaClick","@betaBurger","@gammaGem","@omegaTap"
  ];
  const shuffled = sample.sort(()=>Math.random()-0.5).slice(0,50);
  return shuffled.map(n=> [0, n, Math.floor(Math.random()*5_000_000 + 50_000)]);
}
function getDailyRank(){
  const key="burgercoin-rank-v2";
  const day = 24*3600*1000;
  const saved = JSON.parse(localStorage.getItem(key)||"null");
  if(saved && (now()-saved.time < day)) return saved.list;
  const list = generateFakeRankList();
  localStorage.setItem(key, JSON.stringify({time: now(), list}));
  return list;
}

/* ===== Render ===== */
function renderTop(){
  $("#coins").textContent = fmt(S.coins);
  $("#energy").textContent = Math.floor(S.energy);
  $("#gems").textContent = S.gems;
  $("#level").textContent = S.level;
  $("#xptext").textContent = S.xp + "/" + S.xpMax + " XP";
  $("#xpbar").style.width = (100*S.xp/S.xpMax) + "%";
  $("#combo").textContent = "x" + S.combo.toFixed(2);
}
function renderDaily(){
  const day = 24*3600*1000;
  const available = (now() - S.daily.last) > day;
  $("#dailyInfo").textContent = available ? "Available" : "Come back tomorrow";
  $("#claimDaily").disabled = !available;
}
function renderShop(){
  const wrap = $("#shopList"); wrap.innerHTML = "";
  Shop.forEach(item=>{
    const lvl = S.upgrades[item.id]?.lvl || 0;
    const price = Math.floor(item.base*Math.pow(item.grow,lvl));
    const div = document.createElement("div");
    div.className = "shopItem";
    div.innerHTML = `
      <div style="font-size:24px">${EMOJI[item.id]}</div>
      <div><b>${item.name} (Lv ${lvl})</b><div class="small">${item.desc}</div></div>
      <div class="right">
        <div class="small">Cost</div>
        <div>🍔 <b>${price}</b></div>
        <button class="btn buy" data-id="${item.id}" ${S.coins<price?'disabled':''}>Buy</button>
      </div>
    `;
    wrap.appendChild(div);
  });
  wrap.querySelectorAll(".buy").forEach(b=> b.onclick = ()=>buy(b.dataset.id));
}
function renderMissions(){
  const wrap = $("#missionList"); wrap.innerHTML = "";
  S.missions.forEach(m=>{
    const p = clamp(m.cur/m.max,0,1);
    const done = m.cur>=m.max;
    const rewardStr = m.type==="gems" ? (m.reward+"💎") : ("🍔 "+m.reward);
    const div = document.createElement("div");
    div.className = "mission";
    div.innerHTML = `
      <div style="font-size:22px">📜</div>
      <div style="flex:1">
        <b>${m.name}</b>
        <div class="small">${m.cur}/${m.max} • Reward: <b>${rewardStr}</b></div>
        <div class="prog"><div style="width:${p*100}%"></div></div>
      </div>
      <button class="btn claim" ${done?'':'disabled'} data-id="${m.id}">Claim</button>
    `;
    wrap.appendChild(div);
  });
  wrap.querySelectorAll(".claim").forEach(b=> b.onclick = ()=>claimMission(b.dataset.id));
}
function renderRank(){
  const wrap = $("#rankTable"); wrap.innerHTML = "";
  // get daily fake list
  let list = getDailyRank();

  // add current user (telegram username if available)
  let username = $("#username").textContent;
  if(username && username.startsWith("@")){
    list.push([0, username, Math.floor(S.coins)]);
  }else{
    list.push([0, "@you", Math.floor(S.coins)]);
  }

  // sort & reindex
  list.sort((a,b)=> b[2]-a[2]);
  list = list.map((r,i)=> [i+1, r[1], r[2]]).slice(0, 100); // cap

  list.forEach(r=>{
    const row = document.createElement("div");
    row.className = "tr";
    row.innerHTML = `<div><b>#${r[0]}</b></div><div>${r[1]}</div><div>🍔 <b>${fmt(r[2])}</b></div>`;
    wrap.appendChild(row);
  });
}
function renderAll(){ renderTop(); renderDaily(); renderShop(); renderMissions(); renderRank(); }
renderAll();

/* ===== Mechanics ===== */
function tap(){
  if(S.energy<1){ toast("Out of energy 🔋"); blip(160,0.1,"square",0.3); return; }
  S.energy -= 1;

  let perTap = 1 + (S.upgrades.finger.lvl||0);
  if(S.pass) perTap *= 1.1;
  perTap *= S.combo;
  if(S.boostMs>0) perTap *= 2;

  // crit x3
  const critChance = (S.upgrades.crit.lvl||0)*0.05;
  const crit = Math.random() < critChance;
  if(crit) perTap *= 3;

  S.coins += perTap;
  S.xp += 2;
  const mt = S.missions.find(m=>m.id==="taps"); if(mt) mt.cur++;

  if(S.xp>=S.xpMax){
    S.level++; S.xp -= S.xpMax; S.xpMax = Math.floor(S.xpMax*1.25);
    toast("LEVEL UP! 🔥"); chord([523.25,659.25,783.99],0.35);
  } else {
    blip(420 + (crit?120:0), 0.06, crit?"triangle":"sine", 0.6);
  }

  S.combo = clamp(S.combo+0.02,1,5);
  S.comboTimer = S.comboMs;

  fly(`+${fmt(perTap)}${crit?' 💥':''}`);
  renderTop(); save();
}

function fly(text){
  const f=$("#fly");
  f.textContent = text;
  f.animate(
    [
      {opacity:0, transform:"translate(-50%,-50%) translateY(10px)"},
      {opacity:1, transform:"translate(-50%,-50%) translateY(-6px)"},
      {opacity:0, transform:"translate(-50%,-50%) translateY(-18px)"}
    ],
    {duration:650, easing:"ease-out"}
  );
}

/* Timers: energy regen, combo decay, miner, offline label */
let lastTick = now();
function tick(){
  const t = now();
  const dt = t - lastTick; lastTick = t;

  // energy regen
  S._e = (S._e||0) + dt;
  while(S._e >= S.energyEveryMs){
    S._e -= S.energyEveryMs;
    S.energy = clamp(S.energy + S.energyRegen, 0, S.maxEnergy);
  }

  // combo decay
  if(S.comboTimer>0){ S.comboTimer -= dt; if(S.comboTimer<=0){ S.combo=1; } }

  // boost timer
  if(S.boostMs>0){ S.boostMs -= dt; if(S.boostMs<0) S.boostMs=0; }

  // miner passive
  const miner = S.upgrades.miner.lvl||0;
  if(miner>0){
    S._m = (S._m||0) + dt;
    while(S._m>=1000){
      S._m -= 1000;
      let gain = 1*miner;
      if(S.pass) gain *= 1.1;
      S.coins += gain;
    }
  }

  // update offline label
  $("#offline").textContent = Math.floor((t - S.lastSeen)/1000) + "s";

  renderTop();
  save();
  requestAnimationFrame(tick);
}
requestAnimationFrame(tick);

/* Offline earnings on load */
(function handleOffline(){
  const elapsed = now() - S.lastSeen;
  if(elapsed>5000){
    const hours = Math.min(8, elapsed/3600000);
    const mult = 0.1 * (S.upgrades.offline.lvl||0);
    const miner = (S.upgrades.miner.lvl||0);
    const basePerSec = miner;
    const reward = basePerSec * hours * 3600 * mult;
    if(reward>0){ S.coins += reward; toast("Offline gains: +" + fmt(reward)); }
  }
  S.lastSeen = now();
  save();
})();

/* Actions */
$("#tapBtn").onclick = ()=>{ initAudio(); startIntroMusic(); tap(); };

$("#claimDaily").onclick = ()=>{
  initAudio(); blip(660,0.08,"square",0.5);
  const day = 24*3600*1000;
  if(now()-S.daily.last < day) return;
  S.daily.last = now();
  S.daily.streak = Math.min(30, S.daily.streak+1);
  const reward = 80 * S.daily.streak;
  S.coins += reward;
  toast("Daily +"+fmt(reward)+" (streak "+S.daily.streak+")");
  renderDaily(); renderTop(); save();
};

$("#boost").onclick = ()=>{
  initAudio(); blip(520,0.08,"triangle",0.5);
  if(S.boostMs>0){ toast("Boost already active"); return; }
  if(S.gems<1){ toast("Need gems 💎"); blip(160,0.12,"square",0.25); return; }
  S.gems -= 1;
  S.boostMs = 60000;
  toast("Boost x2 for 60s!");
  renderTop(); save();
};

/* Shop */
function buy(id){
  initAudio();
  const item = Shop.find(s=>s.id===id);
  const lvl = S.upgrades[id].lvl||0;
  const price = Math.floor(item.base*Math.pow(item.grow,lvl));
  if(S.coins<price){ toast("Not enough coins"); blip(160,0.12,"square",0.25); return; }
  S.coins -= price;
  S.upgrades[id].lvl = lvl+1;
  if(id==="energy"){ S.maxEnergy += 10; S.energyRegen += 0.2; }
  blip(700,0.08,"sine",0.6);
  toast(item.name+" Lv "+(lvl+1)+" purchased!");
  renderTop(); renderShop(); save();
}

/* Missions claim */
function claimMission(id){
  initAudio();
  const m = S.missions.find(x=>x.id===id);
  if(!m || m.cur<m.max) return;
  if(m.type==="gems"){ S.gems += m.reward; } else { S.coins += m.reward; }
  blip(760,0.1,"triangle",0.6);
  toast("Mission reward: +" + (m.type==="gems" ? (m.reward+"💎") : (m.reward+" 🍔")));
  // regenerate simple loop missions
  if(m.id!=="level"){
    m.cur = 0;
    m.max = Math.floor(m.max*1.8);
    m.reward = Math.floor(m.reward*1.8);
  }
  renderMissions(); renderTop(); save();
}

/* Wheel */
$("#spinWheel").onclick = ()=>{
  initAudio();
  if(S.gems<1){ toast("Need 1 gem"); blip(160,0.12,"square",0.25); return; }
  if(S.wheelCooldown>now()){ toast("Please wait..."); return; }
  S.gems -= 1; renderTop();
  const wheel = $("#wheel");
  const deg = 360*5 + Math.floor(Math.random()*360);
  wheel.style.transition = "transform 2.2s cubic-bezier(.2,.8,.2,1)";
  wheel.style.transform = `rotate(${deg}deg)`;
  chord([392,523,659],0.5);
  setTimeout(()=>{
    const sector = Math.floor(((deg%360)+22.5)/45)%8;
    const rewards = [100, 1, 300, 2, 150, 1, 500, 3]; // coins/gems alternati
    let reward = rewards[sector];
    if(sector%2===0){ S.coins += reward; toast("Wheel: +"+fmt(reward)+" 🍔"); }
    else{ S.gems += reward; toast("Wheel: +"+reward+"💎"); }
    blip(520,0.1,"sine",0.5);
    S.wheelCooldown = now()+2000;
    renderTop(); save();
  }, 2300);
};

/* Tabs */
$$(".tab").forEach(t=> t.onclick = ()=>{
  initAudio(); blip(380,0.06,"sine",0.4);
  $$(".tab").forEach(x=>x.classList.remove("active"));
  t.classList.add("active");
  const id = t.dataset.view;
  $$(".view").forEach(v=> v.classList.remove("active"));
  $("#view-"+id).classList.add("active");
});

/* Anti-cheat rudimentale */
(function antiCheat(){
  const origSetItem = localStorage.setItem;
  localStorage.setItem = function(k,v){
    if(k===STATE_KEY){
      try{ const data=JSON.parse(v); if(data.coins>1e15) return; }catch(e){}
    }
    return origSetItem.apply(this, arguments);
  };
})();

/* Mission hooks periodic */
setInterval(()=>{
  const mc = S.missions.find(x=>x.id==="coins"); if(mc){ mc.cur = Math.max(mc.cur, Math.floor(S.coins)); }
  const ml = S.missions.find(x=>x.id==="level"); if(ml){ ml.cur = Math.max(ml.cur, S.level); }
  renderMissions(); save();
}, 1500);

/* Save on unload */
window.addEventListener("beforeunload", ()=>{ S.lastSeen = now(); save(); });

/* ===== Splash logic ===== */
window.addEventListener("load", ()=>{
  const splash = $("#splash");
  const bar = $("#progress-bar");
  const app = $("#app");
  let progress = 0;
  const it = setInterval(()=>{
    progress += Math.random()*18;
    if(progress>=100){
      progress=100; clearInterval(it);
      setTimeout(()=>{
        splash.style.opacity = 0;
        setTimeout(()=>{
          splash.style.display="none";
          app.removeAttribute("aria-hidden");
        }, 620);
      }, 280);
    }
    bar.style.width = progress+"%";
  }, 300);
});

</script>
</body>
</html>
