<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover"/>
<title>BurgerCoin — Idle Tap</title>
<meta name="theme-color" content="#0a2a68"/>
<style>
/* Same CSS styles as before... */
</style>
</head>
<body>
<!-- SUONO CLICK -->
<audio id="clickSound" src="click.wav" preload="auto"></audio>

<!-- SPLASH -->
<div id="splash">
  <div class="splash-card">
    <img src="burger_image.png" alt="BurgerCoin logo" style="width:140px; border-radius:50%; margin-bottom:12px;"/>
    <div class="splash-logo" style="font-size:28px; font-weight:900; margin:6px 0;">🍔 BurgerCoin</div>
    <div class="splash-progress"><div id="progress-bar"></div></div>
  </div>
</div>

<!-- GAME -->
<div class="app" id="app" aria-hidden="true">
  <div class="topbar">
    <div class="pill"><img src="burger_image.png" class="icoCoin"/> <b id="coins">0</b></div>
    <div class="pill">⚡ <b id="energy">100</b> <small id="energyTimer" style="font-size:10px;opacity:0.7;margin-left:4px;">60s</small></div>
    <div class="pill">💎 <b id="gems">0</b></div>
  </div>

  <div class="balance-pill">
    <div class="pill">$ <b id="balance">0.00</b></div>
  </div>

  <h1 class="title">Burger Coin</h1>

  <div class="coinContainer">
    <div class="progress">
      <div class="badge">Lvl <b id="level">1</b></div>
      <div class="track"><div class="bar" id="xpbar"></div></div>
      <div class="badge"><b id="xptext">0/100 XP</b></div>
    </div>
    <div class="coinBtn" id="coinBtn"></div>
    <div class="combo" id="combo">Combo 1.00x</div>
  </div>

  <div class="buttonContainer">
    <button class="button">💰 Wallet</button>
    <button class="button">🎯 Mission</button>
    <button class="button">🎡 Wheel</button>
    <button class="button">🔧 Upgrade</button>
    <button class="button">🃏 Burger Jack</button>
    <button class="button">🏆 Leaderboard</button>
  </div>

  <div class="footer">by Burger Games</div>
</div>

<script>
// Gestione variabili
let progress = 0;
const progressBar = document.getElementById("progress-bar");

function updateProgressBar() {
  progress += Math.random() * 20;
  if (progress >= 100) {
    progress = 100;
    setTimeout(() => {
      document.getElementById("splash").style.opacity = 0;
      setTimeout(() => {
        document.getElementById("splash").style.display = "none";
        document.getElementById("app").removeAttribute("aria-hidden");
        saveGame();
      }, 600);
    }, 300);
  }
  progressBar.style.width = progress + "%";
}
setInterval(updateProgressBar, 300);

// VARIABILI DI GIOCO
let coins = 0, energy = 100, xp = 0, level = 1, xpToNext = 100, combo = 1, balance = 0, gems = 0;
let comboTimer;

// RIFERIMENTI UI
const coinsEl = document.getElementById('coins');
const energyEl = document.getElementById('energy');
const xptextEl = document.getElementById('xptext');
const levelEl = document.getElementById('level');
const xpbarEl = document.getElementById('xpbar');
const comboEl = document.getElementById('combo');
const balanceEl = document.getElementById('balance');
const gemsEl = document.getElementById('gems');
const energyTimerEl = document.getElementById('energyTimer');

// PERSISTENZA
const SAVE_KEY = 'burgercoin_save_v1';

function saveGame() {
  const data = {coins, energy, xp, level, xpToNext, combo, balance, gems, lastSave: Date.now()};
  localStorage.setItem(SAVE_KEY, JSON.stringify(data));
}

function loadGame() {
  const raw = localStorage.getItem(SAVE_KEY);
  if (!raw) return;
  const d = JSON.parse(raw);
  coins = d.coins || 0; 
  energy = (d.energy >= 0 ? d.energy : 0); // Evita che l'energia venga mai impostata a valori superiori o inferiori al limite
  xp = d.xp || 0; 
  level = d.level || 1;
  xpToNext = d.xpToNext || 100; 
  combo = d.combo || 1; 
  balance = d.balance || 0; 
  gems = d.gems || 0;

  // Aggiorna l'energia dopo il login basandosi sul tempo
  if (d.lastSave) {
    const minutesPassed = Math.floor((Date.now() - d.lastSave) / 60000);
    energy = Math.max(0, energy + minutesPassed);  // Mantieni energia a zero se è a zero
  }
  
  updateUI();
}

window.addEventListener('beforeunload', saveGame);
setInterval(saveGame, 5000);

function updateUI() {
  coinsEl.textContent = Math.floor(coins);
  energyEl.textContent = energy;
  xptextEl.textContent = `${xp}/${xpToNext} XP`;
  levelEl.textContent = level;
  xpbarEl.style.width = (xp / xpToNext * 100) + "%";
  balanceEl.textContent = balance.toFixed(2);
  comboEl.textContent = `Combo ${combo.toFixed(2)}x`;
  gemsEl.textContent = gems;
}

// --- FUNZIONE POPUP ---
function showPopup(x, y, text, size = 16) {
  const popup = document.createElement("div");
  popup.className = "popup";
  popup.style.left = x + "px";
  popup.style.top = y + "px";
  popup.style.fontSize = size + "px";
  popup.textContent = text;
  document.body.appendChild(popup);
  setTimeout(() => popup.remove(), 800);
}

// --- TIMER ENERGIA ---
let energyCountdown = 60;
setInterval(() => {
  if (energy < 500) {
    energyCountdown--;
    if (energyCountdown <= 0) {
      energy++;
      energyCountdown = 60;
      updateUI();
      saveGame();
    }
    energyTimerEl.textContent = energyCountdown + "s";
  } else {
    energyTimerEl.textContent = "MAX";
    energyCountdown = 60;
  }
}, 1000);

// CLICK MONETA
document.getElementById('coinBtn').addEventListener('click', (e) => {
  if (energy > 0) {
    let earnedCoins = 1 * combo;
    coins += earnedCoins;
    energy--; xp += 5;
    if (xp >= xpToNext) { xp = 0; level++; xpToNext = Math.floor(xpToNext * 1.5); }
    if (Math.floor(coins / 10) > Math.floor((coins - earnedCoins) / 10)) balance += 0.01;

    combo = Math.min(3, (combo + 0.01));
    comboEl.textContent = `Combo ${combo.toFixed(2)}x`;
    comboEl.style.transform = "scale(1.2)";
    setTimeout(() => comboEl.style.transform = "scale(1)", 100);

    clearTimeout(comboTimer);
    comboTimer = setTimeout(() => { combo = 1; comboEl.textContent = "Combo 1.00x"; saveGame(); }, 7000);

    updateUI(); saveGame();

    // ANIMAZIONE
    const coinBtn = document.getElementById('coinBtn');
    coinBtn.classList.remove('clicked');
    void coinBtn.offsetWidth;
    coinBtn.classList.add('clicked');

    // SUONO (funziona anche con click rapidi)
    const sound = new Audio("click.wav");
    sound.play().catch(()=>{});

    // POPUP +🍔
    const rect = coinBtn.getBoundingClientRect();
    const x = rect.left + rect.width / 2 + (Math.random() * 60 - 30);
    const y = rect.top + rect.height / 2 + (Math.random() * 60 - 30);
    const size = 14 + Math.min(earnedCoins, 30);
    showPopup(x, y, `+🍔${earnedCoins.toFixed(0)}`, size);
  }
});

loadGame(); updateUI();
</script>
</body>
</html>
